- name: remove old docker image
  docker_image:
    name: "{{ inventory_hostname }}"
    tag: "{{ build_vars.tag }}"
    state: absent
  become: yes
  tags: [ never, rebuild ]

- name: perform docker build
  environment:
    DOCKER_BUILDKIT: "1"
  docker_image:
    name: "{{ inventory_hostname }}"
    tag: "{{ build_vars.tag }}"
    source: build
    push: no
    build:
      path: "{{ docker_build_directory.path }}"
  become: yes
  register: docker_build_result

- name: check docker build created new image
  assert:
    fail_msg: new docker image not created. to force overwriting existing image specify --tags=all,rebuild
    that:
      - docker_build_result.changed
